<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Fundaci√≥n APASCOVI ¬∑ Encuesta de satisfacci√≥n</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- EmailJS para env√≠o autom√°tico -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

  <style>
    :root{
      --bg:#0f172a;
      --card:#ffffff;
      --border:#e5e7eb;
      --text:#020617;
      --muted:#64748b;
      --accent:#22c55e;
      --accent-dark:#16a34a;
    }

    *{box-sizing:border-box;}

    html, body{
      margin:0;
      padding:0;
    }

    body{
      background:var(--bg);
      color:var(--text);
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
    }

    .shell{
      width:100%;
      max-width:1100px;
      margin:0 auto;
      padding:8px;
    }

    .card{
      background:var(--card);
      border-radius:18px;
      border:1px solid #1f2937;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
      display:flex;
      flex-direction:column;
      min-height:0;
    }

    header{
      padding:18px 22px;
      background:#020617;
      color:#e5e7eb;
      display:flex;
      flex-wrap:wrap;
      justify-content:flex-start;
      align-items:center;
      gap:12px;
    }

    .header-main{
      display:flex;
      align-items:center;
      gap:12px;
    }

    header h1{
      margin:0;
      font-size:1.8rem;
    }

    header p{
      margin:4px 0 0;
      font-size:1.05rem;
      color:#cbd5f5;
    }

    .body{
      padding:18px 22px 20px;
      background:#f8fafc;
      font-size:1.05rem; /* base un poco mayor */
    }

    .notice{
      background:#e0f2fe;
      border-left:4px solid #0284c7;
      padding:12px 14px;
      border-radius:12px;
      color:#0f172a;
      font-size:1.05rem;
      margin-bottom:18px;
    }

    fieldset{
      border:none;
      margin:0 0 16px;
      padding:0;
    }

    legend{
      font-weight:700;
      margin-bottom:10px;
      font-size:1.15rem;
    }

    .grid-2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px 18px;
    }

    @media(max-width:800px){
      .grid-2{grid-template-columns:1fr;}
    }

    label{
      font-size:1rem;
      display:block;
      margin-bottom:4px;
      color:#0f172a;
    }

    input[type="text"],
    input[type="number"],
    input[type="date"],
    textarea{
      width:100%;
      padding:10px 11px;
      border-radius:10px;
      border:1px solid var(--border);
      font-size:1rem;
    }

    textarea{
      min-height:90px;
      resize:vertical;
    }

    .block-title{
      margin:18px 0 6px;
      font-weight:800;
      font-size:1.25rem;
      text-transform:uppercase;
      color:#0f172a;
    }

    .block-desc{
      margin:0 0 10px;
      font-size:1rem;
      color:var(--muted);
    }

    .q{
      background:#ffffff;
      border-radius:16px;
      border:1px solid #e2e8f0;
      padding:14px 12px;
      margin-bottom:12px;
    }

    .q-head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
    }

    .q-text{
      margin:0;
      font-size:1.25rem; /* texto de pregunta m√°s grande */
      line-height:1.4;
      flex:1;
    }

    /* Bot√≥n ESCUCHAR m√°s grande */
    .audio-btn{
      border:none;
      border-radius:999px;
      background:#e5e7eb;
      color:#0f172a;
      padding:10px 16px;
      font-size:1rem;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      white-space:nowrap;
    }

    .audio-btn:hover{
      background:#cbd5f5;
    }

    .audio-btn:focus{
      outline:2px solid #2563eb;
      outline-offset:1px;
    }

    /* FILA DE PICTOGRAMAS ARRIBA ‚Äì ahora bastante m√°s grandes */
    .pictos-row{
      display:flex;
      flex-wrap:wrap;
      gap:18px;
      margin-bottom:10px;
      align-items:center;
      justify-content:flex-start;
    }

    .picto-elem{
      border:3px solid #000;
      border-radius:8px;
      padding:6px;
      background:#ffffff;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .picto-elem img{
      width:135px;
      height:135px;
      object-fit:contain;
      display:block;
    }

    /* CARITAS NO / A VECES / S√ç ‚Äì m√°s grandes */
    .faces3{
      display:flex;
      flex-wrap:wrap;
      gap:40px;
      margin-top:10px;
      align-items:flex-start;
      justify-content:flex-start;
    }

    .faceopt{
      display:inline-flex;
      flex-direction:column;
      align-items:center;
      cursor:pointer;
      touch-action:manipulation;
    }

    .faceopt input{
      display:none;
    }

    .face-circle{
      width:84px;
      height:84px;
      border-radius:999px;
      border:5px solid #e5e7eb;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:40px;
      background:#ffffff;
      transition:.1s transform,.1s box-shadow,.1s border-color,.1s background-color;
    }

    .face-no   { border-color:#f97373; color:#b91c1c; }
    .face-ave  { border-color:#facc15; color:#92400e; }
    .face-si   { border-color:#4ade80; color:#166534; }

    .faceopt input:checked + .face-circle{
      box-shadow:0 0 0 4px rgba(15,23,42,.18);
      transform:translateY(-2px) scale(1.04);
    }

    .faceopt:hover .face-circle{
      transform:translateY(-1px);
    }

    .face-caption{
      margin-top:6px;
      font-size:1rem;
      font-weight:700;
      text-transform:uppercase;
      text-align:center;
    }

    footer{
      padding:12px 18px;
      background:#020617;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }

    .btn{
      border:none;
      border-radius:999px;
      padding:10px 18px;
      font-size:1rem;
      font-weight:700;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      touch-action:manipulation;
    }

    .btn-primary{
      background:var(--accent);
      color:#022c22;
    }

    .btn-primary:hover{background:var(--accent-dark);}

    .btn-secondary{
      background:#1f2937;
      color:#e5e7eb;
    }

    .btn-secondary:hover{background:#111827;}

    .status{
      font-size:.9rem;
      color:#e5e7eb;
      min-height:1.2em;
    }

    @media print{
      body{background:#ffffff;}
      .shell{max-width:100%;padding:0;margin:0;}
      .card{box-shadow:none;border:none;border-radius:0;}
      header, footer{display:none;}
      .body{padding:10px 12px;}
      .q{page-break-inside:avoid;}
      .audio-btn{display:none;}
    }
  </style>
</head>
<body>
<div class="shell">
  <div class="card">
    <header>
      <div class="header-main">
        <div>
          <h1>Fundaci√≥n APASCOVI: Tu satisfacci√≥n nos importa.</h1>
          <p>Encuesta de satisfacci√≥n para personas usuarias del centro / servicio</p>
        </div>
      </div>
    </header>

    <div class="body">
      <div class="notice">
        Mira los dibujos, lee la pregunta y elige <strong>NO</strong>, <strong>A VECES</strong> o <strong>S√ç</strong>.
      </div>

      <form id="surveyForm">
        <!-- DATOS GENERALES -->
        <fieldset>
          <legend>Datos generales</legend>
          <div class="grid-2">
            <div>
              <label for="centro">Nombre del centro</label>
              <input type="text" id="centro" name="centro">
            </div>
            <div>
              <label for="codigo">Iniciales / c√≥digo (opcional)</label>
              <input type="text" id="codigo" name="codigo">
            </div>
            <div>
              <label for="antY">A√±os que llevas en el centro</label>
              <input type="number" id="antY" name="antY" min="0">
            </div>
            <div>
              <label for="antM">Meses que llevas en el centro</label>
              <input type="number" id="antM" name="antM" min="0" max="11">
            </div>
            <div>
              <label for="fecha">Fecha</label>
              <input type="date" id="fecha" name="fecha">
            </div>
          </div>
        </fieldset>

        <div id="questions"></div>

        <fieldset>
          <legend>Valoraci√≥n general ‚Äì comentario libre</legend>
          <label for="comentarios">¬øQuieres a√±adir alguna sugerencia u opini√≥n?</label>
          <textarea id="comentarios" name="comentarios"></textarea>
        </fieldset>
      </form>
    </div>

    <footer>
      <div class="status" id="statusText"></div>
      <div>
        <button class="btn btn-secondary" type="button" onclick="window.print()">
          üßæ Imprimir / Guardar en PDF
        </button>
        <button class="btn btn-primary" type="button" onclick="submitSurvey()">
          üì§ Enviar encuesta
        </button>
      </div>
    </footer>
  </div>
</div>

<script>
  const EMAILJS_SERVICE_ID  = "service_21hna5e";
  const EMAILJS_TEMPLATE_ID = "template_hk12dtc";
  const EMAILJS_PUBLIC_KEY  = "DYhSYQdRHJthVBMRU";
  const DESTINO = "idiaz@apascovi.org";

  document.addEventListener("DOMContentLoaded", () => {
    emailjs.init({ publicKey: EMAILJS_PUBLIC_KEY });
    renderQuestions();
  });

  const audioCache = {};
  let currentAudio = null;

  function playQuestionAudio(qId){
    const src = "audio/" + qId + ".mp3";
    if(!audioCache[qId]){
      audioCache[qId] = new Audio(src);
    }
    const audio = audioCache[qId];

    if(currentAudio && currentAudio !== audio){
      currentAudio.pause();
      currentAudio.currentTime = 0;
    }

    currentAudio = audio;
    currentAudio.currentTime = 0;

    currentAudio.play().catch(err=>{
      console.error("Error reproduciendo audio:", err);
      alert("No se ha podido reproducir el audio de esta pregunta.\n\nAseg√∫rate de que existe el archivo:\n" + src);
    });
  }

  const THREE_SCALE = [
    { value: "NO",  label: "No",      emoji: "‚òπÔ∏è" },
    { value: "AVE", label: "A veces", emoji: "üòê" },
    { value: "SI",  label: "S√≠",      emoji: "üôÇ" }
  ];

  const QUESTIONS = [
    {
      id: "Q1",
      block: "ENTORNO F√çSICO: LAS INSTALACIONES DEL CENTRO Y SU ENTORNO",
      text: "1. ¬øLas zonas comunes y muebles que hay en tu centro son c√≥modos?",
      pictos: [
        { src: "./img/salon.png",   alt: "Sala de estar del centro" },
        { src: "./img/comedor.png", alt: "Comedor del centro" },
        { src: "./img/tele.png",    alt: "Persona viendo la televisi√≥n" }
      ]
    }
  ];

  function renderQuestions(){
    const container = document.getElementById("questions");
    let currentBlock = "";
    QUESTIONS.forEach(q=>{
      if(q.block !== currentBlock){
        currentBlock = q.block;
        const bt = document.createElement("div");
        bt.className = "block-title";
        bt.textContent = currentBlock;
        container.appendChild(bt);

        const bd = document.createElement("div");
        bd.className = "block-desc";
        bd.textContent = "Mira los dibujos, lee la pregunta y elige NO, A VECES o S√ç.";
        container.appendChild(bd);
      }

      const box = document.createElement("div");
      box.className = "q";

      if(q.pictos && q.pictos.length){
        const pictosRow = document.createElement("div");
        pictosRow.className = "pictos-row";

        q.pictos.forEach(pic=>{
          const wrap = document.createElement("div");
          wrap.className = "picto-elem";

          const img = document.createElement("img");
          img.src = pic.src;
          img.alt = pic.alt || "";

          wrap.appendChild(img);
          pictosRow.appendChild(wrap);
        });

        box.appendChild(pictosRow);
      }

      const head = document.createElement("div");
      head.className = "q-head";

      const p = document.createElement("p");
      p.className = "q-text";
      p.textContent = q.text;
      head.appendChild(p);

      const audioBtn = document.createElement("button");
      audioBtn.type = "button";
      audioBtn.className = "audio-btn";
      audioBtn.textContent = "üîä Escuchar";
      audioBtn.setAttribute("aria-label","Escuchar la pregunta");
      audioBtn.addEventListener("click", () => {
        playQuestionAudio(q.id);
      });
      head.appendChild(audioBtn);

      box.appendChild(head);

      const faces = document.createElement("div");
      faces.className = "faces3";

      THREE_SCALE.forEach(opt=>{
        const label = document.createElement("label");
        label.className = "faceopt";

        const input = document.createElement("input");
        input.type = "radio";
        input.name = q.id;
        input.value = opt.value;

        const faceCircle = document.createElement("span");
        faceCircle.className = "face-circle " +
          (opt.value === "NO" ? "face-no" : opt.value === "AVE" ? "face-ave" : "face-si");
        faceCircle.textContent = opt.emoji;

        const cap = document.createElement("span");
        cap.className = "face-caption";
        cap.textContent = opt.label.toUpperCase();

        label.appendChild(input);
        label.appendChild(faceCircle);
        label.appendChild(cap);
        faces.appendChild(label);
      });

      box.appendChild(faces);
      container.appendChild(box);
    });
  }

  function getSurveyData(){
    const form = document.getElementById("surveyForm");
    const data = {
      centro: form.centro.value.trim(),
      codigo: form.codigo.value.trim(),
      antY: form.antY.value.trim(),
      antM: form.antM.value.trim(),
      fecha: form.fecha.value,
      comentarios: form.comentarios.value.trim(),
      answers: []
    };

    QUESTIONS.forEach((q, index)=>{
      const sel = form.querySelector('input[name="'+q.id+'"]:checked');
      let label = "";
      if(sel){
        const found = THREE_SCALE.find(s => s.value === sel.value);
        label = found ? found.label : "";
      }
      data.answers.push({
        n: index+1,
        id: q.id,
        text: q.text,
        value: sel ? sel.value : "",
        label: label
      });
    });

    return data;
  }

  function validateSurvey(data){
    return data.answers.filter(a => !a.value);
  }

  function composePlainText(data){
    const lines = [];
    lines.push("Fundaci√≥n APASCOVI: Tu satisfacci√≥n nos importa.");
    lines.push("ENCUESTA DE SATISFACCI√ìN ‚Äì Centro / servicio");
    lines.push("");
    lines.push("Centro: " + (data.centro || "(sin indicar)"));
    lines.push("C√≥digo/Iniciales: " + (data.codigo || "(sin indicar)"));
    const antig = (data.antY ? data.antY+" a√±os " : "") + (data.antM ? data.antM+" meses" : "");
    lines.push("Antig√ºedad en el centro: " + (antig || "(sin indicar)"));
    lines.push("Fecha: " + (data.fecha || "(sin indicar)"));
    lines.push("");
    lines.push("Escala: NO / A VECES / S√ç");
    lines.push("");

    data.answers.forEach(a=>{
      lines.push(a.text);
      lines.push("   Respuesta: " + (a.label || "(sin respuesta)") + " [" + (a.value || "-") + "]");
      lines.push("");
    });

    if(data.comentarios){
      lines.push("Comentario libre:");
      lines.push(data.comentarios);
      lines.push("");
    }
    return lines.join("\n");
  }

  function setStatus(msg, isError=false){
    const el = document.getElementById("statusText");
    el.textContent = msg || "";
    el.style.color = isError ? "#fecaca" : "#bbf7d0";
  }

  function submitSurvey(){
    const data = getSurveyData();
    const missing = validateSurvey(data);

    if(missing.length){
      alert("Falta contestar alguna pregunta. Recuerda marcar NO, A VECES o S√ç.");
      const first = missing[0];
      const node = document.querySelector('input[name="'+first.id+'"]');
      if(node){ node.scrollIntoView({behavior:"smooth", block:"center"}); node.focus(); }
      return;
    }

    const textBody = composePlainText(data);
    setStatus("Enviando encuesta‚Ä¶");

    const params = {
      to_email: DESTINO,
      centro: data.centro,
      fecha: data.fecha,
      cuerpo_encuesta: textBody
    };

    emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, params)
      .then(()=>{
        setStatus("Encuesta enviada correctamente. Muchas gracias.");
        document.getElementById("surveyForm").reset();
      })
      .catch(err=>{
        console.error("EmailJS error:", err);
        setStatus("Error al enviar la encuesta. Revisa la configuraci√≥n de EmailJS.", true);

        const detalle = err && (err.text || err.message || JSON.stringify(err));
        alert("Error al enviar la encuesta.\n\nDetalle que devuelve EmailJS:\n" + detalle);
      });
  }
</script>
</body>
</html>